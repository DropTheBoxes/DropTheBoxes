<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>인증번호 입력</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='verify.css') }}">
</head>
<body>
    <div class="title">휴대폰에 전송된 비밀번호 4자리를 입력하세요.</div>

    <div class="input-box" id="pinDisplay">____</div>

    <!-- 사용자 정보 숨김 -->
    <input type="hidden" id="lockerId" value="{{ locker_id }}">
    <input type="hidden" id="userId" name="user_id" value="{{ user_id }}">
    <input type="hidden" id="userName" name="name" value="{{ name }}">
    <input type="hidden" id="userPhone" name="phone" value="{{ phone }}">

    <div class="keypad">
        {% for num in range(1, 10) %}
            <button onclick="appendPin('{{ num }}')">{{ num }}</button>
        {% endfor %}
        <button onclick="deletePin()">삭제</button>
        <button onclick="appendPin('0')">0</button>
        <button onclick="submitPin()">확인</button>
    </div>

    <div class="bottom-nav">
        <a href="/">처음으로</a>
        <a href="/user_home?user_id = {{ user_id }}&name = {{ name }}&phone = {{ phone }}">이전으로</a>
    </div>

    <script>
        let pin = "";

        function appendPin(num) {
            if (pin.length < 4) {
                pin += num;
                updateDisplay();
            }
        }

        function deletePin() {
            pin = pin.slice(0, -1);
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('pinDisplay').innerText = pin.padEnd(4, '_');
        }

        function submitPin() {
            if (pin.length === 4) {
                const lockerId = document.getElementById('lockerId').value;
                const userId = document.getElementById('userId').value;
                const name = document.getElementById('userName').value;
                const phone = document.getElementById('userPhone').value;

                fetch('/verify_pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        pin: pin,
                        locker_id: lockerId,
                        user_id: userId,
                        name: name,
                        phone: phone
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) {
                        window.location.href = `/user_home?user_id=${userId}&name=${name}&phone=${phone}`;
                    } else {
                        if (data.new_password) {
                            alert("새 비밀번호: " + data.new_password);
                        }
                    }
                })
                .catch(error => {
                    console.error('에러:', error);
                    alert("서버 통신 실패");
                });
            } else {
                alert("4자리를 모두 입력해주세요.");
            }
        }
    </script>
</body>
</html>
